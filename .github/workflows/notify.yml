name: Karuta Timer Notify üå∏

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: V√©rifie si le timer est actif
        id: check
        run: |
          if [ ! -f timer_state.json ]; then
            echo '{"active": true}' > timer_state.json
          fi
          ACTIVE=$(jq -r '.active' timer_state.json)
          echo "active=$ACTIVE" >> $GITHUB_OUTPUT

      - name: Envoie notif Discord
        if: steps.check.outputs.active == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          IMAGE_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/assets/mwa.gif"
          FOOTER="Powered by GitHub Actions ‚Ä¢ Made with üíñ by Spincka"
          DESC=$'Il est temps de farmer tes cartes, Senpai ! ‚ú®\n\nClique sur le bouton ci-dessous pour relancer le timer. üíï'

          curl -H "Content-Type: application/json" \
               -d "$(jq -n \
               --arg title "üå∏ Karuta Timer" \
               --arg desc "$DESC" \
               --arg url "https://discord.com/api/webhooks/YOUR_BOT_ENDPOINT" \
               --arg image "$IMAGE_URL" \
               --arg footer "$FOOTER" \
               '{
                 "embeds": [
                   {
                     "title": $title,
                     "description": $desc,
                     "color": 15548997,
                     "url": $url,
                     "image": {"url": $image},
                     "footer": {"text": $footer}
                   }
                 ],
                 "components": [
                   {
                     "type": 1,
                     "components": [
                       {
                         "type": 2,
                         "style": 5,
                         "label": "üí´ Relancer le timer",
                         "url": $url
                       }
                     ]
                   }
                 ]
               }')" \
               $DISCORD_WEBHOOK_URL

          jq '.active = false' timer_state.json > tmp && mv tmp timer_state.json
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add timer_state.json
          git commit -m "Pause timer apr√®s notif"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:main
